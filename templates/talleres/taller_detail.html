{% extends 'base.html' %}
{% load static %}
{% load talleres_filters %}

{% block title %}{{ taller.nombre }} | APRODMAYO{% endblock %}

{% block custom_css %}
<style>
    .info-card {
        transition: all .2s;
    }
    .info-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .section-title {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .progress-wrapper {
        position: relative;
        height: 10px;
    }
    .progress-label {
        position: absolute;
        right: 0;
        top: -25px;
    }
    .badge-periodo {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.8rem;
    }
    .action-buttons {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .detail-list {
        list-style: none;
        padding-left: 0;
    }
    .detail-list li {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .detail-list li:last-child {
        border-bottom: none;
    }
    .material-item {
        border-left: 3px solid #6c757d;
        padding-left: 15px;
    }
    .material-item.documento {
        border-left-color: #007bff;
    }
    .material-item.presentacion {
        border-left-color: #28a745;
    }
    .material-item.video {
        border-left-color: #dc3545;
    }
    .material-item.audio {
        border-left-color: #ffc107;
    }
    .material-item.otro {
        border-left-color: #6c757d;
    }
    .tab-content {
        padding: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'taller_list' %}">Talleres</a></li>
            <li class="breadcrumb-item active">{{ taller.nombre }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Columna principal -->
        <div class="col-lg-8">
            <!-- Cabecera del taller -->
            <div class="card mb-4 position-relative">
                {% if es_taller_actual %}
                    <div class="badge-periodo badge bg-success">En curso</div>
                {% elif es_taller_futuro %}
                    <div class="badge-periodo badge bg-info">Próximamente</div>
                {% else %}
                    <div class="badge-periodo badge bg-secondary">Finalizado</div>
                {% endif %}
                
                <div class="card-body">
                    <h1 class="h3 mb-3">{{ taller.nombre }}</h1>
                    <p class="lead">{{ taller.descripcion }}</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3 text-center">
                                    <i class="fas fa-user-tie fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Facilitador</small>
                                    <div class="fw-bold">{{ taller.facilitador }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3 text-center">
                                    <i class="fas fa-map-marker-alt fa-2x text-danger"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Lugar</small>
                                    <div class="fw-bold">{{ taller.lugar }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3 text-center">
                                    <i class="fas fa-calendar-alt fa-2x text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Período</small>
                                    <div class="fw-bold">{{ taller.fecha_inicio|date:"d/m/Y" }} - {{ taller.fecha_fin|date:"d/m/Y" }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3 text-center">
                                    <i class="fas fa-clock fa-2x text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Horario</small>
                                    <div class="fw-bold">{{ taller.horario }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5 class="fw-bold">Objetivos</h5>
                        <p>{{ taller.objetivos|default:"No se han definido objetivos para este taller." }}</p>
                    </div>
                    
                    <div class="action-buttons">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="dropdownMenuButton" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                Acciones
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                <li>
                                    <a class="dropdown-item" href="{% url 'taller_update' taller.id %}">
                                        <i class="fas fa-edit me-2"></i>Editar taller
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'participante_list' taller.id %}">
                                        <i class="fas fa-users me-2"></i>Gestionar participantes
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'asistencia_list' taller.id %}">
                                        <i class="fas fa-clipboard-check me-2"></i>Control de asistencia
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'evaluacion_list' taller.id %}">
                                        <i class="fas fa-star-half-alt me-2"></i>Evaluaciones
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'material_list' taller.id %}">
                                        <i class="fas fa-file-alt me-2"></i>Materiales
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'reporte_asistencia' taller.id %}">
                                        <i class="fas fa-chart-bar me-2"></i>Reporte de asistencia
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'reporte_evaluaciones' taller.id %}">
                                        <i class="fas fa-chart-line me-2"></i>Reporte de evaluaciones
                                    </a>
                                </li>
                                {% if taller.estado == 'FINALIZADO' %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'certificados_taller' taller.id %}">
                                        <i class="fas fa-certificate me-2"></i>Certificados
                                    </a>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{% url 'taller_delete' taller.id %}">
                                        <i class="fas fa-trash-alt me-2"></i>Eliminar taller
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Información en pestañas (sin JavaScript) -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Participantes del Taller</h5>
                </div>
                <div class="card-body">
                    <!-- Lista de participantes -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Lista de Participantes</h4>
                        <div>
                            <a href="{% url 'participante_list' taller.id %}" class="btn btn-sm btn-outline-secondary me-2">
                                Ver todos
                            </a>
                            <a href="{% url 'participante_create' taller.id %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus me-2"></i>Inscribir Participante
                            </a>
                        </div>
                    </div>
                    
                    {% if participantes %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>DNI</th>
                                        <th>Estado</th>
                                        <th>Tipo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participante in participantes|slice:":10" %}
                                        <tr>
                                            <td>
                                                <div class="fw-bold">{{ participante.nombres }} {{ participante.apellidos }}</div>
                                                {% if participante.beneficiaria %}
                                                    <small class="text-muted">Beneficiaria vinculada</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ participante.dni }}</td>
                                            <td>
                                                {% if participante.estado == 'CONFIRMADO' %}
                                                    <span class="badge bg-success">Confirmado</span>
                                                {% elif participante.estado == 'PENDIENTE' %}
                                                    <span class="badge bg-warning">Pendiente</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Retirado</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ participante.get_tipo_display }}</td>
                                            <td>
                                                <a href="{% url 'participante_detail' participante.id %}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if participantes.count > 10 %}
                            <div class="text-center mt-3">
                                <a href="{% url 'participante_list' taller.id %}" class="btn btn-outline-primary btn-sm">
                                    Ver todos los participantes ({{ participantes.count }})
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay participantes registrados en este taller.
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Materiales del Taller</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Materiales del Taller</h4>
                        <div>
                            <a href="{% url 'material_list' taller.id %}" class="btn btn-sm btn-outline-secondary me-2">
                                Ver todos
                            </a>
                            <a href="{% url 'material_create' taller.id %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus me-2"></i>Agregar material
                            </a>
                        </div>
                    </div>
                    
                    {% if materiales %}
                        <div class="row">
                            {% for material in materiales|slice:":6" %}
                                <div class="col-md-6 mb-3">
                                    <div class="card material-item {{ material.tipo|lower }}">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ material.titulo }}</h5>
                                            <h6 class="card-subtitle mb-2 text-muted">
                                                <i class="fas fa-{% if material.tipo == 'DOCUMENTO' %}file-pdf{% elif material.tipo == 'PRESENTACION' %}file-powerpoint{% elif material.tipo == 'VIDEO' %}video{% elif material.tipo == 'AUDIO' %}music{% else %}file-alt{% endif %} me-1"></i>
                                                {{ material.get_tipo_display }}
                                            </h6>
                                            <p class="card-text">{{ material.descripcion|truncatechars:100 }}</p>
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">
                                                    {{ material.fecha_creacion|date:"d/m/Y" }}
                                                </small>
                                                <a href="{% url 'material_detail' material.id %}" class="card-link">Ver detalles</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% if materiales.count > 6 %}
                            <div class="text-center mt-3">
                                <a href="{% url 'material_list' taller.id %}" class="btn btn-outline-primary btn-sm">
                                    Ver todos los materiales ({{ materiales.count }})
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay materiales registrados para este taller.
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Control de Asistencia</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Control de Asistencia</h4>
                        <div>
                            <a href="{% url 'asistencia_list' taller.id %}" class="btn btn-sm btn-outline-secondary me-2">
                                Ver registros
                            </a>
                            <a href="{% url 'asistencia_masiva' taller.id %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-clipboard-list me-2"></i>Registrar asistencia
                            </a>
                        </div>
                    </div>
                    
                    {% if es_taller_actual %}
                        <div class="text-center mb-3">
                            <a href="{% url 'asistencia_masiva' taller.id %}" class="btn btn-primary">
                                <i class="fas fa-clipboard-list me-2"></i>Registrar asistencia de hoy
                            </a>
                        </div>
                    {% elif es_taller_futuro %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            El taller aún no ha comenzado. La asistencia se podrá registrar a partir del {{ taller.fecha_inicio|date:"d/m/Y" }}.
                        </div>
                    {% else %}
                        <div class="alert alert-secondary">
                            <i class="fas fa-check-circle me-2"></i>
                            El taller ha finalizado. Puede consultar los reportes de asistencia para ver el historial completo.
                        </div>
                        <div class="text-center">
                            <a href="{% url 'reporte_asistencia' taller.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-chart-bar me-2"></i>Ver reporte de asistencia
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Columna lateral -->
        <div class="col-lg-4">
            <!-- Resumen del taller -->
            <div class="card mb-4 info-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información del Taller</h5>
                </div>
                <div class="card-body">
                    <ul class="detail-list">
                        <li class="d-flex justify-content-between">
                            <span class="text-muted">Estado:</span>
                            <span class="fw-bold">
                                {% if taller.estado == 'PROGRAMADO' %}
                                    <span class="badge bg-warning">Programado</span>
                                {% elif taller.estado == 'EN_CURSO' %}
                                    <span class="badge bg-success">En curso</span>
                                {% elif taller.estado == 'FINALIZADO' %}
                                    <span class="badge bg-secondary">Finalizado</span>
                                {% else %}
                                    <span class="badge bg-danger">Cancelado</span>
                                {% endif %}
                            </span>
                        </li>
                        <li class="d-flex justify-content-between">
                            <span class="text-muted">Tipo:</span>
                            <span class="fw-bold">{{ taller.get_tipo_display }}</span>
                        </li>
                        <li class="d-flex justify-content-between">
                            <span class="text-muted">Duración:</span>
                            <span class="fw-bold">{{ total_sesiones }} sesiones</span>
                        </li>
                        <li class="d-flex justify-content-between">
                            <span class="text-muted">Participantes:</span>
                            <span class="fw-bold">{{ total_participantes }} / {{ taller.capacidad }}</span>
                        </li>
                        <li>
                            <div class="mb-1 d-flex justify-content-between">
                                <span class="text-muted">Ocupación:</span>
                                <span class="fw-bold">{{ porcentaje_ocupacion|floatformat:1 }}%</span>
                            </div>
                            <div class="text-center">
                                <span class="badge {% if porcentaje_ocupacion < 50 %}bg-info{% elif porcentaje_ocupacion < 80 %}bg-success{% elif porcentaje_ocupacion < 100 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ porcentaje_ocupacion|default_if_none:0|floatformat:1 }}% de ocupación
                                </span>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="card-footer bg-light d-flex justify-content-between">
                    {% if disponibilidad > 0 and taller.estado == 'PROGRAMADO' or taller.estado == 'EN_CURSO' %}
                        <div>
                            <span class="badge bg-info">{{ disponibilidad }} cupos disponibles</span>
                        </div>
                        <a href="{% url 'participante_create' taller.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-user-plus me-1"></i>Inscribir Participante
                        </a>
                    {% elif taller.estado == 'PROGRAMADO' or taller.estado == 'EN_CURSO' %}
                        <span class="badge bg-danger">Cupos llenos</span>
                    {% else %}
                        <span class="badge bg-secondary">Taller no disponible</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Acciones rápidas -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Acciones Rápidas</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'participante_list' taller.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-users me-2 text-primary"></i>
                            Gestionar Participantes
                        </div>
                        <span class="badge bg-primary rounded-pill">{{ total_participantes }}</span>
                    </a>
                    <a href="{% url 'asistencia_masiva' taller.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-clipboard-check me-2 text-success"></i>
                            Registrar Asistencia
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                    <a href="{% url 'evaluacion_list' taller.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-star-half-alt me-2 text-warning"></i>
                            Evaluaciones
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                    <a href="{% url 'material_create' taller.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-upload me-2 text-info"></i>
                            Agregar Material
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                </div>
            </div>
            
            <!-- Reportes -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Reportes</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'reporte_asistencia' taller.id %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Reporte de Asistencia</h6>
                            <i class="fas fa-chart-bar text-primary"></i>
                        </div>
                        <small class="text-muted">Ver estadísticas de asistencia por participante y fecha</small>
                    </a>
                    <a href="{% url 'reporte_evaluaciones' taller.id %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Reporte de Evaluaciones</h6>
                            <i class="fas fa-chart-line text-primary"></i>
                        </div>
                        <small class="text-muted">Ver calificaciones y promedios de los participantes</small>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
